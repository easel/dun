id: helix
version: "2.0.0"
description: "Helix workflow validation and agent checks"
priority: 50
triggers:
  - type: path-exists
    value: docs/helix
checks:
  - id: helix-state-rules
    description: "Validate Helix workflow progression"
    type: state-rules
    phase: frame
    state_rules: state-rules.yml

  - id: helix-gates
    description: "Validate Helix phase gates"
    type: gates
    phase: frame
    gate_files:
      - gates/01-frame/input-gates.yml
      - gates/01-frame/exit-gates.yml
      - gates/02-design/input-gates.yml
      - gates/03-test/input-gates.yml
      - gates/04-build/input-gates.yml
      - gates/05-deploy/input-gates.yml
      - gates/06-iterate/input-gates.yml

  - id: helix-create-architecture
    description: "Create architecture doc when missing"
    type: agent
    phase: design
    conditions:
      - type: path-exists
        path: docs/helix/01-frame/prd.md
      - type: path-missing
        path: docs/helix/02-design/architecture.md
    inputs:
      - docs/helix/01-frame/prd.md
    prompt: prompts/create-architecture.md
    response_schema: responses/agent-default.json

  - id: helix-create-feature-specs
    description: "Create feature specs when missing"
    type: agent
    phase: frame
    conditions:
      - type: path-exists
        path: docs/helix/02-design/architecture.md
      - type: glob-max-count
        path: docs/helix/01-frame/features/*.md
        expected: 0
    inputs:
      - docs/helix/01-frame/prd.md
      - docs/helix/02-design/architecture.md
    prompt: prompts/create-feature-specs.md
    response_schema: responses/agent-default.json

  - id: helix-align-specs
    description: "Compare PRD, architecture, and feature specs"
    type: agent
    phase: design
    conditions:
      - type: path-exists
        path: docs/helix/01-frame/prd.md
      - type: path-exists
        path: docs/helix/02-design/architecture.md
      - type: path-exists
        path: docs/helix/03-test/test-plan.md
      - type: glob-min-count
        path: docs/helix/01-frame/features/*.md
        expected: 1
    inputs:
      - docs/helix/01-frame/prd.md
      - docs/helix/02-design/architecture.md
      - docs/helix/01-frame/features/*.md
    prompt: prompts/align-specs.md
    response_schema: responses/agent-default.json

  - id: helix-reconcile-stack
    description: "Plan doc/code reconciliation across Helix artifacts"
    type: agent
    phase: iterate
    conditions:
      - type: path-exists
        path: docs/helix/01-frame/prd.md
      - type: path-exists
        path: docs/helix/02-design/architecture.md
      - type: glob-min-count
        path: docs/helix/01-frame/features/*.md
        expected: 1
    inputs:
      - docs/helix/01-frame/prd.md
      - docs/helix/01-frame/features/*.md
      - docs/helix/01-frame/user-stories/*.md
      - docs/helix/02-design/**/*.md
      - docs/helix/03-test/test-plan.md
    prompt: prompts/reconcile-stack.md
    response_schema: responses/agent-default.json

  - id: helix-spec-binding
    description: "Verify feature specs have implementations"
    type: spec-binding
    phase: build
    bindings:
      specs:
        - pattern: docs/helix/01-frame/user-stories/US-*.md
          implementation_section: "## Implementation"
          id_pattern: "US-\\d+"
      code:
        - pattern: internal/**/*.go
          spec_comment: "// Implements: US-"
        - pattern: cmd/**/*.go
          spec_comment: "// Implements: US-"
    binding_rules:
      - type: no-orphan-specs
        warn_only: true
      - type: no-orphan-code
        warn_only: true

  - id: helix-doc-dag
    description: "Detect missing or stale Helix docs"
    type: doc-dag
    phase: iterate

  - id: helix-change-cascade
    description: "Verify downstream updates when PRD changes"
    type: change-cascade
    phase: iterate
    trigger: git-diff
    baseline: HEAD~1
    cascade_rules:
      - upstream: docs/helix/01-frame/prd.md
        downstreams:
          - path: docs/helix/02-design/architecture.md
            required: true
          - path: docs/helix/01-frame/user-stories/*.md
            required: true

  - id: helix-integration-contract
    description: "Verify integration contracts and dependencies"
    type: integration-contract
    phase: build
    conditions:
      - type: path-exists
        path: docs/helix/02-design/integration-map.yaml
    contracts:
      map: docs/helix/02-design/integration-map.yaml
      definitions: internal/**/*.go
    contract_rules:
      - type: all-providers-implemented
      - type: all-consumers-satisfied
      - type: no-circular-dependencies

  - id: helix-conflict-detection
    description: "Detect overlapping agent work"
    type: conflict-detection
    phase: build
    tracking:
      manifest: .dun/work-in-progress.yaml
    conflict_rules:
      - type: no-overlap
        scope: file
        required: false
